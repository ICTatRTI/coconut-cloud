matchResults=document.location.pathname.match(/^\/(.*)\/_design\/(.*?)\//),Backbone.couch_connector.config.db_name=matchResults[1],Backbone.couch_connector.config.ddoc_name=matchResults[2],Backbone.couch_connector.config.global_changes=!1;
var User,UserCollection,__extends=function(r,e){function t(){this.constructor=r}for(var o in e)__hasProp.call(e,o)&&(r[o]=e[o]);return t.prototype=e.prototype,r.prototype=new t,r.__super__=e.prototype,r},__hasProp={}.hasOwnProperty;User=function(r){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,r),e.prototype.url="/user",e.prototype.username=function(){return this.get("_id").replace(/^user\./,"")},e.prototype.passwordIsValid=function(r){return this.get("password")===r},e.prototype.isAdmin=function(){return"admin"===this.username()},e.prototype.login=function(){return $.cookie("current_user",this.username()),$("#user").html(this.username()),$("#district").html(this.get("district")),$("a[href=#logout]").show(),$("a[href=#login]").hide(),this.isAdmin()?$("#manage-button").show():$("#manage-button").hide(),e.currentUser=this},e.prototype.refreshLogin=function(){return this.login()},e}(Backbone.Model),User.isAuthenticated=function(r){var e;return null!=$.cookie("current_user")?(e=new User({_id:"user."+$.cookie("current_user")}),e.fetch({success:function(){return e.refreshLogin(),r.success(e)},error:function(){return r.error()}})):r.error()},User.logout=function(){return $.cookie("current_user",""),$("#user").html(""),$("#district").html(""),$("a[href=#logout]").hide(),$("a[href=#login]").show(),User.currentUser=null},UserCollection=function(r){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,r),e.prototype.model=User,e.prototype.url="/user",e}(Backbone.Collection);
var Config,__extends=function(t,o){function n(){this.constructor=t}for(var r in o)__hasProp.call(o,r)&&(t[r]=o[r]);return n.prototype=o.prototype,t.prototype=new n,t.__super__=o.prototype,t},__hasProp={}.hasOwnProperty;Config=function(t){function o(){return o.__super__.constructor.apply(this,arguments)}return __extends(o,t),o.prototype.initialize=function(){return this.set({_id:"coconut.config"})},o.prototype.fetch=function(t){return o.__super__.fetch.call(this,{success:function(){return Coconut.config.local=new LocalConfig,Coconut.config.local.fetch({success:function(){return"function"==typeof t.success?t.success():void 0},error:function(){return"function"==typeof t.error?t.error():void 0}})},error:function(){return"function"==typeof t.error?t.error():void 0}})},o.prototype.url="/configuration",o.prototype.title=function(){return this.get("title")||"Coconut"},o.prototype.database_name=function(){return Backbone.couch_connector.config.db_name},o.prototype.design_doc_name=function(){return Backbone.couch_connector.config.ddoc_name},o.prototype.cloud_url=function(){return""+this.get("synchronization_target")},o.prototype.cloud_url_with_credentials=function(){return this.cloud_url().replace(/http:\/\//,"http://"+this.get("cloud_credentials")+"@")},o}(Backbone.Model);
var Question,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__extends=function(t,e){function n(){this.constructor=t}for(var i in e)__hasProp.call(e,i)&&(t[i]=e[i]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},__hasProp={}.hasOwnProperty;Question=function(t){function e(){return this.summaryFieldNames=__bind(this.summaryFieldNames,this),this.resultSummaryFields=__bind(this.resultSummaryFields,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.type=function(){return this.get("type")},e.prototype.label=function(){return this.get(null!=this.get("label")?"label":"id")},e.prototype.safeLabel=function(){return this.label().replace(/[^a-zA-Z0-9 -]/g,"").replace(/[ -]/g,"")},e.prototype.repeatable=function(){return this.get("repeatable")},e.prototype.questions=function(){return this.get("questions")},e.prototype.value=function(){return null!=this.get("value")?this.get("value"):""},e.prototype.required=function(){return null!=this.get("required")?this.get("required"):"true"},e.prototype.validation=function(){return null!=this.get("validation")?this.get("validation"):null},e.prototype.skipLogic=function(){return this.get("skip_logic")||""},e.prototype.actionOnChange=function(){return this.get("action_on_change")||""},e.prototype.attributeSafeText=function(){var t;return t=this.get(null!=this.get("label")?"label":"id"),t.replace(/[^a-zA-Z0-9]/g,"")},e.prototype.url="/question",e.prototype.set=function(t){return null!=t.questions&&(t.questions=_.map(t.questions,function(t){return new e(t)})),null!=t.id&&(t._id=t.id),e.__super__.set.call(this,t)},e.prototype.loadFromDesigner=function(t){var n,i,r,o,u,s;if(r=e.fromDomNode(t),1===r.length){for(r=r[0],this.set({id:r.id}),s=["label","type","repeatable","required","validation"],o=0,u=s.length;u>o;o++)i=s[o],n={},n[i]=r.get(i),this.set(n);return this.set({questions:r.questions()})}throw"More than one root node"},e.prototype.resultSummaryFields=function(){var t,e,n,i;return e=this.get("resultSummaryFields"),e?e:(t=Math.min(2,this.questions().length-1),n={},_.each(function(){i=[];for(var e=0;t>=0?t>=e:e>=t;t>=0?e++:e--)i.push(e);return i}.apply(this),function(t){return function(e){var i;return n[null!=(i=t.questions()[e])?i.label():void 0]="on"}}(this)),n)},e.prototype.summaryFieldNames=function(){return _.keys(this.resultSummaryFields())},e.prototype.summaryFieldKeys=function(){return _.map(this.summaryFieldNames(),function(t){return t.replace(/[^a-zA-Z0-9 -]/g,"").replace(/[ -]/g,"")})},e}(Backbone.Model),Question.fromDomNode=function(t){return _(t).chain().map(function(){return function(t){var e,n,i,r,o,u,s,a;if(t=$(t),n=t.attr("id"),t.children("#rootQuestionName").length>0&&(n=t.children("#rootQuestionName").val()),n){for(o=new Question,o.set({id:n}),a=["label","type","repeatable","select-options","radio-options","autocomplete-options","validation","required","action_on_questions_loaded","skip_logic","action_on_change","image-path","image-style"],u=0,s=a.length;s>u;u++)i=a[u],e={},r=t.find("#"+i+"-"+n).val(),"required"===i&&(r=String(t.find("#"+i+"-"+n).is(":checked"))),null!=r&&(e[i]=r,o.set(e));return o.set({safeLabel:o.safeLabel()}),t.find(".question-definition").length>0&&o.set({questions:Question.fromDomNode(t.children(".question-definition"))}),o}}}(this)).compact().value()};
var QuestionCollection,__extends=function(o,t){function e(){this.constructor=o}for(var n in t)__hasProp.call(t,n)&&(o[n]=t[n]);return e.prototype=t.prototype,o.prototype=new e,o.__super__=t.prototype,o},__hasProp={}.hasOwnProperty;QuestionCollection=function(o){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,o),t.prototype.model=Question,t.prototype.url="/question",t}(Backbone.Collection);
var Result,__extends=function(t,e){function o(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t},__hasProp={}.hasOwnProperty;Result=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.initialize=function(){return this.attributes.createdAt||this.set({createdAt:moment(new Date).format(Coconut.config.get("date_format"))}),this.attributes.lastModifiedAt?void 0:this.set({lastModifiedAt:moment(new Date).format(Coconut.config.get("date_format"))})},e.prototype.url="/result",e.prototype.question=function(){return this.get("question")},e.prototype.tags=function(){var t;return t=this.get("Tags"),null!=t?t.split(/, */):[]},e.prototype.complete=function(){var t;return _.include(this.tags(),"complete")?!0:(t=this.get("complete"),"undefined"==typeof t&&(t=this.get("Complete")),null===t||"undefined"==typeof t?!1:t===!0||t.match(/true|yes/)?!0:void 0)},e.prototype.shortString=function(){var t;return t=this.string,t.length>40?t.substring(0,40)+"...":t},e.prototype.summaryKeys=function(t){var e;return e=t.summaryFieldKeys(),0===e.length&&(e=_.difference(_.keys(this.toJSON()),["_id","_rev","complete","question","collection"])),e},e.prototype.summaryValues=function(t){return _.map(this.summaryKeys(t),function(t){return function(e){var o;return o=t.get(e)||"","object"==typeof o&&(o=JSON.stringify(o)),o}}(this))},e.prototype.get=function(t){var o,n;return n=e.__super__.get.call(this,t),null!=n&&"cloud"===Coconut.config.local.get("mode")&&(o=Coconut.config.get("identifying_attributes"),null!=o&&_.contains(o,t))?b64_sha1(n):n},e.prototype.toJSON=function(){var t;return t=e.__super__.toJSON.call(this),"cloud"===Coconut.config.local.get("mode")&&_.each(t,function(e){return function(o,n){return null!=o&&_.contains(e.identifyingAttributes,n)?t[n]=b64_sha1(o):void 0}}(this)),t},e.prototype.save=function(t,o,n){return this.set({user:$.cookie("current_user"),lastModifiedAt:moment(new Date).format(Coconut.config.get("date_format"))}),e.__super__.save.call(this,t,o,n)},e}(Backbone.Model);
var ResultCollection,__extends=function(t,e){function o(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t},__hasProp={}.hasOwnProperty;ResultCollection=function(t){function e(){return e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.model=Result,e.prototype.url="/result",e.prototype.db={view:"resultsByQuestionAndComplete"},e.prototype.fetch=function(t){return null==t&&(t={}),null==t.include_docs&&(t.include_docs=!0),(null!=t?t.question:void 0)&&(t.descending="true",null!=t.isComplete?(t.startkey=t.question+":"+t.isComplete+":z",t.endkey=t.question+":"+t.isComplete):(t.startkey=t.question+":z",t.endkey=t.question)),e.__super__.fetch.call(this,t)},e.prototype.notSent=function(){return this.filter(function(t){var e;return!(null!=(e=t.get("sentTo"))?e.length:void 0)})},e.prototype.filteredByQuestionCategorizedByStatus=function(t){var e;return e={},e.complete=[],e.notCompete=[],this.each(function(o){if(o.get("question")===t)switch(o.get("complete")){case!0:return e.complete.push(o);default:return e.notComplete.push(o)}}),e},e.prototype.filterByQuestionType=function(t){return this.filter(function(e){return e.get("question")===t})},e.prototype.partialResults=function(t){return this.filter(function(e){return e.get("question")===t&&!e.complete()})},e}(Backbone.Collection);
var Sync,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__extends=function(t,e){function o(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t},__hasProp={}.hasOwnProperty;Sync=function(t){function e(){return this.replicateApplicationDocs=__bind(this.replicateApplicationDocs,this),this.getFromCloud=__bind(this.getFromCloud,this),this.log=__bind(this.log,this),this.last_get_time=__bind(this.last_get_time,this),this.was_last_get_successful=__bind(this.was_last_get_successful,this),this.last_send_time=__bind(this.last_send_time,this),this.was_last_send_successful=__bind(this.was_last_send_successful,this),this.last_send=__bind(this.last_send,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.initialize=function(){return this.set({_id:"SyncLog"})},e.prototype.url="/sync",e.prototype.target=function(){return Coconut.config.cloud_url()},e.prototype.last_send=function(){return this.get("last_send_result")},e.prototype.was_last_send_successful=function(){var t;return this.get("last_send_error")===!0?!1:(t=this.last_send(),null==t?!1:null!=t.no_changes&&t.no_changes===!0?!0:t.docs_read===t.docs_written&&0===t.doc_write_failures)},e.prototype.last_send_time=function(){var t;return t=this.get("last_send_time"),t?moment(this.get("last_send_time")).fromNow():"never"},e.prototype.was_last_get_successful=function(){return this.get("last_get_success")},e.prototype.last_get_time=function(){var t;return t=this.get("last_get_time"),t?moment(this.get("last_get_time")).fromNow():"never"},e.prototype.sendToCloud=function(t){return this.fetch({error:function(t){return function(e){return t.log("Unable to fetch Sync doc: "+JSON.stringify(e))}}(this),success:function(e){return function(){return e.log("Checking for internet. (Is "+Coconut.config.cloud_url()+" is reachable?) Please wait."),$.ajax({dataType:"jsonp",url:Coconut.config.cloud_url(),error:function(o){return e.log("ERROR! "+Coconut.config.cloud_url()+" is not reachable. Do you have enough airtime? Are you on WIFI?  Either the internet is not working or the site is down: "+JSON.stringify(o)),t.error(),e.save({last_send_error:!0})},success:function(){return e.log(Coconut.config.cloud_url()+" is reachable, so internet is available."),e.log("Creating list of all results on the tablet. Please wait."),$.couch.db(Coconut.config.database_name()).view(Coconut.config.design_doc_name()+"/results",{include_docs:!1,error:function(){return e.log("Could not retrieve list of results: "+JSON.stringify(error)),t.error(),e.save({last_send_error:!0})},success:function(o){var n;return e.log("Synchronizing "+o.rows.length+" results. Please wait."),n=_.pluck(o.rows,"id"),$.couch.db(Coconut.config.database_name()).saveDoc({collection:"log",action:"sendToCloud",user:User.currentUser.id,time:moment().format(Coconut.config.get("date_format"))},{error:function(t){return e.log("Could not create log file: "+JSON.stringify(t))},success:function(){return $.couch.replicate(Coconut.config.database_name(),Coconut.config.cloud_url_with_credentials(),{success:function(o){return e.log("Send data finished: created, updated or deleted "+o.docs_written+" results on the server."),e.save({last_send_result:o,last_send_error:!1,last_send_time:(new Date).getTime()}),e.sendLogMessagesToCloud({success:function(){return t.success()},error:function(e){return this.save({last_send_error:!0}),t.error(e)}})}},{doc_ids:n}),Coconut.menuView.checkReplicationStatus()}})}})}})}}(this)})},e.prototype.log=function(t){return Coconut.debug(t)},e.prototype.sendLogMessagesToCloud=function(t){return this.fetch({error:function(t){return function(e){return t.log("Unable to fetch Sync doc: "+JSON.stringify(e))}}(this),success:function(e){return function(){return $.couch.db(Coconut.config.database_name()).view(Coconut.config.design_doc_name()+"/byCollection",{key:"log",include_docs:!1,error:function(o){return e.log("Could not retrieve list of log entries: "+JSON.stringify(o)),t.error(o),e.save({last_send_error:!0})},success:function(o){var n;return e.log("Sending "+o.rows.length+" log entries. Please wait."),n=_.pluck(o.rows,"id"),$.couch.replicate(Coconut.config.database_name(),Coconut.config.cloud_url_with_credentials(),{success:function(o){return e.save({last_send_result:o,last_send_error:!1,last_send_time:(new Date).getTime()}),e.log("Successfully sent "+o.docs_written+" log messages to the server."),t.success()},error:function(o){return e.log("Could not send log messages to the server: "+JSON.stringify(o)),e.save({last_send_error:!0}),"function"==typeof t.error?t.error(o):void 0}},{doc_ids:n}),Coconut.menuView.checkReplicationStatus()}})}}(this)})},e.prototype.getFromCloud=function(t){return this.fetch({error:function(t){return function(e){return t.log("Unable to fetch Sync doc: "+JSON.stringify(e))}}(this),success:function(e){return function(){return e.log("Checking that "+Coconut.config.cloud_url()+" is reachable. Please wait."),$.ajax({dataType:"jsonp",url:Coconut.config.cloud_url(),error:function(o){return e.log("ERROR! "+Coconut.config.cloud_url()+" is not reachable. Do you have enough airtime? Are you on WIFI?  Either the internet is not working or the site is down: "+JSON.stringify(o)),"function"==typeof t.error?t.error(o):void 0},success:function(){return e.log(Coconut.config.cloud_url()+" is reachable, so internet is available."),e.fetch({success:function(){return e.log("Updating users, forms and the design document. Please wait."),e.replicateApplicationDocs({error:function(o){return $.couch.logout(),e.log("ERROR updating application: "+JSON.stringify(o)),e.save({last_get_success:!1}),null!=t&&"function"==typeof t.error?t.error(o):void 0},success:function(){return $.couch.logout(),$.couch.db(Coconut.config.database_name()).saveDoc({collection:"log",action:"getFromCloud",user:User.currentUser.id,time:moment().format(Coconut.config.get("date_format"))},{error:function(t){return e.log("Could not create log file "+JSON.stringify(t))},success:function(){return e.log("Sending log messages to cloud."),e.sendLogMessagesToCloud({success:function(){return e.log("Finished, refreshing app in 5 seconds..."),e.fetch({error:function(t){return e.log("Unable to fetch Sync doc: "+JSON.stringify(t))},success:function(){return e.save({last_get_success:!0,last_get_time:(new Date).getTime()}),null!=t&&"function"==typeof t.success&&t.success(),_.delay(function(){return document.location.reload()},5e3)}})}})}})}})}})}})}}(this)})},e.prototype.replicate=function(t){return $.couch.login({name:Coconut.config.get("local_couchdb_admin_username"),password:Coconut.config.get("local_couchdb_admin_password"),success:function(){return $.couch.replicate(Coconut.config.cloud_url_with_credentials(),Coconut.config.database_name(),{success:function(){return t.success()},error:function(){return t.error()}},t.replicationArguments),Coconut.menuView.checkReplicationStatus()},error:function(){return console.log("Unable to login as local admin for replicating the design document (main application)")}})},e.prototype.replicateApplicationDocs=function(t){return $.ajax({dataType:"jsonp",url:Coconut.config.cloud_url_with_credentials()+"/_design/"+Coconut.config.design_doc_name()+"/_view/docIDsForUpdating",include_docs:!1,error:function(){return function(e,o,n){return"function"==typeof t.error?t.error(n):void 0}}(this),success:function(e){return function(o){var n;return n=_.pluck(o.rows,"id"),n.push("_design/"+Coconut.config.design_doc_name()),e.log("Updating "+n.length+" docs (users, forms and the design document). Please wait."),e.replicate(_.extend(t,{replicationArguments:{doc_ids:n}}))}}(this)})},e}(Backbone.Model);
var LocalConfig,__extends=function(o,t){function n(){this.constructor=o}for(var r in t)__hasProp.call(t,r)&&(o[r]=t[r]);return n.prototype=t.prototype,o.prototype=new n,o.__super__=t.prototype,o},__hasProp={}.hasOwnProperty;LocalConfig=function(o){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,o),t.prototype.initialize=function(){return this.set({_id:"coconut.config.local"})},t.prototype.url="/local_configuration",t}(Backbone.Model);
var Message,__extends=function(s,t){function e(){this.constructor=s}for(var r in t)__hasProp.call(t,r)&&(s[r]=t[r]);return e.prototype=t.prototype,s.prototype=new e,s.__super__=t.prototype,s},__hasProp={}.hasOwnProperty;Message=function(s){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,s),t.prototype.url="/message",t.prototype.sendSMS=function(s){var t;return t=this.get("to").replace(/^07/,"2557"),$.ajax({url:"https://CHANGEME/bulksms/dispatch.php",dataType:"jsonp",data:{user:"user",password:"pass",msisdn:t,message:this.get("text")},success:function(){return s.success()},error:function(t){return console.log(t),"success"===t.statusText?s.success():s.error(t)}})},t}(Backbone.Model);
var MessageCollection,__extends=function(o,t){function e(){this.constructor=o}for(var r in t)__hasProp.call(t,r)&&(o[r]=t[r]);return e.prototype=t.prototype,o.prototype=new e,o.__super__=t.prototype,o},__hasProp={}.hasOwnProperty;MessageCollection=function(o){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,o),t.prototype.model=Message,t.prototype.url="/message",t}(Backbone.Collection);
var Help,__extends=function(t,o){function r(){this.constructor=t}for(var e in o)__hasProp.call(o,e)&&(t[e]=o[e]);return r.prototype=o.prototype,t.prototype=new r,t.__super__=o.prototype,t},__hasProp={}.hasOwnProperty;Help=function(t){function o(){return o.__super__.constructor.apply(this,arguments)}return __extends(o,t),o.prototype.initialize=function(){},o.prototype.url="/help",o}(Backbone.Model);
var LoginView,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__extends=function(t,e){function n(){this.constructor=t}for(var r in e)__hasProp.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},__hasProp={}.hasOwnProperty;LoginView=function(t){function e(){return this.render=__bind(this.render,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.el="#content",e.prototype.render=function(){return this.$el.html("<style> #login_wrapper{ font-size: 200%; width:50%; margin: 0px auto; } #login_message{ margin-top: 20px; margin-bottom: 20px; } #login_form input{ font-size: 100%; display: block; } #login_form input[type=submit]{ height: 2em; } </style> <div id='login_wrapper'> <div id='login_message'>Please login to continue:</div> <form id='login_form'> <label for='username'>Username</label> <input type='text' id='username' name='username'> <label for='password'>Password</label> <input id='password' name='password' type='password'> <input type='submit' value='Login'> </form> </div>"),$("input[type=text],input[type=password]").textinput(),$("input[type=submit]").button()},e.prototype.events={"submit form#login_form":"login"},e.prototype.updateNavBar=function(){},e.prototype.login=function(){var t,e;return t=$("#login_form").toObject(),e=new User({_id:"user."+t.username}),e.fetch({success:function(n){return function(){return e.passwordIsValid(t.password)?(e.login(),n.callback.success()):$("#login_message").html("Wrong password")}}(this),error:function(){return function(){return $("#login_message").html("Wrong username")}}(this)}),!1},e}(Backbone.View);
var DesignView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__extends=function(e,t){function o(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return o.prototype=t.prototype,e.prototype=new o,e.__super__=t.prototype,e},__hasProp={}.hasOwnProperty;DesignView=function(e){function t(){return this.render=__bind(this.render,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.initialize=function(){return this.question=new Question},t.prototype.el="#content",t.prototype.render=function(){var e;return e={},e.types=this.questionTypes,$("#content").html(this.template(e)),this.basicMode()},t.prototype.template=Handlebars.compile("<div id='design-view'> <h3> Design </h3> <small> <b>Instructions</b>: <p>Use the drop down below to select the type of questions that you will be asking. Click <button>Preview</button> to see what the questions will look like.</p> <div class='advanced'><b>Advanced: </b><p>Use <img title='repeat' src='images/repeat.png' style='background-color:#DDD'/> to make the question repeatable. If you want to group questions together to form a repeatable block then click <img title='group' src='images/group.png' style='background-color:#DDD'/> between the questions and use the <img title='repeat' src='images/repeat.png' style='background-color:#DDD'/> as before. Ungroup by using <img title='ungroup' src='images/ungroup.png' style='background-color:#DDD'/>.</p> </div> </small> <hr/> <div id='questions'> <label for='rootQuestionName'>Name</label> <input id='rootQuestionName' name='rootQuestionName' type='text'/> </div> <label for='element_selector'>Add questions</label> <select id='element_selector'> {{#each types}} <option>{{this}}</option> {{/each}} </select> <button>Add</button><br/> <button type='button'>Save</button> <button>Preview</button> <button>Advanced Mode</button> <hr/> <form id='render'></form> <div id='form_output'></form> </div>"),t.prototype.questionTypes=["text","number","date","datetime","textarea","select","hidden","radio","checkbox","autocomplete from list","autocomplete from previous entries","location","image"],t.prototype.events={"click #design-view button:contains(Add)":"add","click #design-view button[title=group]":"groupClick","click #design-view button[title=ungroup]":"ungroupClick","click #design-view button[title=delete]":"deleteClick","click #design-view button[title=repeat]":"toggleRepeatable","click #design-view button:contains(Preview)":"renderForm","click #design-view button:contains(Show Form Output)":"formDump","click #design-view button:contains(Advanced Mode)":"advancedMode","click #design-view button:contains(Basic Mode)":"basicMode","click #design-view button:contains(Save)":"save"},t.prototype.save=function(){return this.question.loadFromDesigner($("#questions")),this.question.save(null,{success:function(){return Coconut.menuView.render()}})},t.prototype.add=function(e){return this.addQuestion({type:$(e.target).prev().val()})},t.prototype.loadQuestion=function(e){return this.question=new Question({id:e}),this.question.fetch({success:function(e){return function(){return $("#rootQuestionName").val(e.question.id),_.each(e.question.questions(),function(t){return e.addQuestion(t.attributes)})}}(this)})},t.prototype.addQuestion=function(e){var t,o,n,i,r,a,s,u,l;return e.questions&&alert("Support for editing grouped forms not yet implemented"),u=e.type,o=e.id||Math.ceil(1e3*Math.random()),n=e.label||"",r=e.repeatable||"",l=e.validation||"",a=e.required||"",s=e["select-options"]||"option1,option2",i=e["radio-options"]||"option1,option2",t=e["autocomplete-options"]||"option1,option2,option3",$("#questions").children().length>0&&$("#questions").append("<button class='advanced' title='group'><img src='images/group.png'/></button>"),$("#questions").append("<div data-repeat='false' class='question-definition' id='"+o+"'> <div class='question-definition-controls'> <button class='advanced' title='repeat'><img src='images/repeat.png'></button> <input type='hidden' id=repeatable-"+o+" value='false'></input> <button title='delete'><img src='images/delete.png'></button> </div> <div>Type: "+u+"</div> <label for='label-"+o+"'>Label</label> <input type='text' name='label-"+o+"' id='label-"+o+"' value='"+n+"'></input> <label class='advanced' for='required-"+o+"'>Required</label> <input type='checkbox' class='advanced' name='required-"+o+"' id='required-"+o+"' "+("false"===a?"":"checked='true'")+"></textarea> <label class='advanced' for='validation-"+o+"'>Validation</label> <textarea class='advanced' name='validation-"+o+"' id='validation-"+o+"'>"+l+"</textarea> "+function(){switch(u){case"select":return"<label for='select-options-"+o+"'>Select Options</label> <textarea name='select-options-"+o+"' id='select-options-"+o+"'>"+s+"</textarea>";case"radio":return"<label for='radio-options-"+o+"'>Radio Options</label> <textarea name='radio-options-"+o+"' id='radio-options-"+o+"'>"+i+"</textarea>";case"autocomplete from list":return"<label for='autocomplete-options-"+o+"'>Autocomplete Options</label> <textarea name='autocomplete-options-"+o+"' id='autocomplete-options-"+o+"'>"+t+"</textarea>";case"autocomplete from previous entries":return"<input type='hidden' name='autocomplete-from-previous-entries-"+o+"' id='autocomplete-from-previous-entries-"+o+"' value='true'></input>";default:return""}}()+" <input type='hidden' name='type-"+o+"' id='type-"+o+"' value='"+u+"'></input> <input type='hidden' name='required-"+o+"' value='false'></input> </div>")},t.prototype.groupClick=function(e){var t;return t=$(e.target).closest("button"),this.group(t.prev(),t.next()),t.remove()},t.prototype.group=function(e,t){var o,n,i,r,a;for(a=[e,t],i=0,r=a.length;r>i;i++)o=a[i],"false"===o.attr("repeat")&&o.children(".question-definition").length()>0&&this.ungroup(o);return n=Math.ceil(1e3*Math.random()),e.add(t).wrapAll("<div data-repeat='false' class='question-definition' id='"+n+"'> <div class='question-definition-controls'> <button class='advanced' title='repeat'><img src='images/repeat.png'></button> <input type='hidden' id=repeatable-"+n+" value='false'></input> <button title='delete'><img src='images/delete.png'></button> <button class='advanced' title='ungroup'><img src='images/ungroup.png'></button> </div> </div>")},t.prototype.ungroupClick=function(e){var t;return t=$(e.target).closest("button").parent(),this.ungroup(t)},t.prototype.ungroup=function(e){var t,o;return t=e.parent().children(".question-definition-controls"),o=e.parent().children(".question-definition").first(),e.unwrap(),t.remove(),o.after("<button class='advanced' title='group'><img src='images/group.png'/></button>"),e},t.prototype.deleteClick=function(e){return this.deleteQuestion($(e.target).closest(".question-definition"))},t.prototype.deleteQuestion=function(e){var t;return t=e.parent(".question-definition"),2===t.children(".question-definition").length&&this.ungroup(e),1===e.next("button").length?e.next("button").remove():e.prev("button").remove(),e.remove()},t.prototype.toggleRepeatable=function(e){var t,o;return t=$(e.target).closest("button"),o=t.next(),"false"===o.val()?(t.attr("style","background-color:green"),o.val("true")):(t.attr("style",""),o.val("false"))},t.prototype.questions=function(){return $("#questions").children()},t.prototype.toHTMLForm=function(){var e;return this.question.loadFromDesigner($("#questions")),e=new QuestionView({model:this.question}),e.toHTMLForm()},t.prototype.dump=function(){return $("#dump").html(this.toJson())},t.prototype.renderForm=function(){return $("#render").html(this.toHTMLForm()),$("#form_output").html("<hr/> <button type='button'>Show Form Output</button><br/> <textarea id='dump' style='width:400px;height:100px'></textarea>")},t.prototype.formDump=function(){return $("#dump").html(JSON.stringify($("form").toObject()))},t.prototype.advancedMode=function(){return $("body").removeClass("all-advanced-hidden"),$("button:contains(Advanced Mode)").html("Basic Mode")},t.prototype.basicMode=function(){return $("body").addClass("all-advanced-hidden"),$("button:contains(Basic Mode)").html("Advanced Mode")},t}(Backbone.View);
var QuestionView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__extends=function(e,t){function n(){this.constructor=e}for(var i in t)__hasProp.call(t,i)&&(e[i]=t[i]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},__hasProp={}.hasOwnProperty;window.SkipTheseWhen=function(e,t){var n,i,o,a,r,u,s,l;for(o=[],e=e.split(/\s*,\s*/),a=0,u=e.length;u>a;a++)i=e[a],o.push(window.questionCache[i]);for(n="disabled_skipped",l=[],r=0,s=o.length;s>r;r++)i=o[r],l.push(t?i.addClass(n):i.removeClass(n));return l},window.ResultOfQuestion=function(e){var t;return("function"==typeof(t=window.getValueCache)[e]?t[e]():void 0)||null},QuestionView=function(_super){function QuestionView(){return this.render=__bind(this.render,this),QuestionView.__super__.constructor.apply(this,arguments)}return __extends(QuestionView,_super),QuestionView.prototype.initialize=function(){return null==Coconut.resultCollection&&(Coconut.resultCollection=new ResultCollection),this.autoscrollTimer=0},QuestionView.prototype.el="#content",QuestionView.prototype.triggerChangeIn=function(e){var t,n,i,o,a;for(a=[],i=0,o=e.length;o>i;i++)n=e[i],t=[],t.push(window.questionCache[n].find("input, select, textarea, img")),a.push($(t).each(function(e){return function(t,n){var i;return i={target:n},e.actionOnChange(i)}}(this)));return a},QuestionView.prototype.render=function(){var autocompleteElements,skipperList;return this.$el.html("<style> .message { color: grey; font-weight: bold; padding: 10px; border: 1px yellow dotted; background: yellow; display: none; } label.radio { border-radius:20px; display:block; padding:4px 11px; border: 1px solid black; cursor: pointer; text-decoration: none; } input[type='radio']:checked + label { background-color:#ddd; background: #5393c5; background-image: -webkit-gradient(linear,left top,left bottom,from(#5393c5),to(#6facd5)); background-image: -webkit-linear-gradient(#5393c5,#6facd5); background-image: -moz-linear-gradient(#5393c5,#6facd5); background-image: -ms-linear-gradient(#5393c5,#6facd5); background-image: -o-linear-gradient(#5393c5,#6facd5); background-image: linear-gradient(#5393c5,#6facd5); } input[type='radio']{ height: 0px; } div.question.radio{ padding-top: 8px; padding-bottom: 8px; } .tt-hint{ display:none } .tt-dropdown-menu{ width: 100%; background-color: lightgray; } .tt-suggestion{ background-color: white; border-radius:20px; display:block; padding:4px 11px; border: 1px solid black; cursor: pointer; text-decoration: none; } .tt-suggestion .{ } </style> <div style='position:fixed; right:5px; color:white; padding:20px; z-index:5' id='messageText'> <a href='#help/"+this.model.id+"'>Help</a> </div> <div style='position:fixed; right:5px; color:white; background-color: #333; padding:20px; display:none; z-index:10' id='messageText'> Saving... </div> <h1>"+this.model.id+"</h1> <div id='question-view'> <form> "+this.toHTMLForm(this.model)+" </form> </div>"),js2form($("form").get(0),this.result.toJSON()),this.updateCache(),this.updateSkipLogic(),skipperList=[],$(this.model.get("questions")).each(function(){return function(e,t){return t.actionOnChange().match(/skip/i)&&skipperList.push(t.safeLabel()),null!=t.get("action_on_questions_loaded")&&""!==t.get("action_on_questions_loaded")?CoffeeScript.eval(t.get("action_on_questions_loaded")):void 0}}(this)),this.triggerChangeIn(skipperList),this.$el.find("input[type=text],input[type=number],input[type='autocomplete from previous entries'],input[type='autocomplete from list'],input[type='autocomplete from code']").textinput(),this.$el.find("input[type=checkbox]").checkboxradio(),this.$el.find("ul").listview(),this.$el.find("select").selectmenu(),this.$el.find("a").button(),this.$el.find("input[type=date]").datebox({mode:"calbox",dateFormat:"%d-%m-%Y"}),autocompleteElements=[],_.each($("input[type='autocomplete from list']"),function(e){return e=$(e),e.typeahead({local:e.attr("data-autocomplete-options").replace(/\n|\t/,"").split(/, */)}),autocompleteElements.push(e)}),_.each($("input[type='autocomplete from code']"),function(element){return element=$(element),element.typeahead({local:eval(element.attr("data-autocomplete-options"))}),autocompleteElements.push(element)}),_.each($("input[type='autocomplete from previous entries']"),function(e){return e=$(e),e.typeahead({prefetch:document.location.pathname.substring(0,document.location.pathname.indexOf("index.html"))+('_list/values/byValue?key="'+e.attr("name")+'"')}),autocompleteElements.push(e)}),_.each(autocompleteElements,function(e){return function(t){return t.blur(function(){return e.autoscroll(t)})}}(this)),this.readonly?$("input, textarea").attr("readonly","true"):void 0},QuestionView.prototype.events={"change #question-view input":"onChange","change #question-view select":"onChange","change #question-view textarea":"onChange","click #question-view button:contains(+)":"repeat","click #question-view a:contains(Get current location)":"getLocation","click .next_error":"runValidate","click .validate_one":"onValidateOne"},QuestionView.prototype.runValidate=function(){return this.validateAll()},QuestionView.prototype.onChange=function(e){var t,n,i,o;return t=$(e.target),n=t.attr("id"),n===this.oldStamp&&(new Date).getTime()<this.throttleTime+1e3?void 0:(this.throttleTime=(new Date).getTime(),this.oldStamp=n,o=t.attr("name"),"complete"===o?this.changedComplete?void(this.changedComplete=!1):(this.validateAll(),Coconut.menuView.update(),this.save(),this.updateSkipLogic(),this.actionOnChange(e)):(this.changedComplete=!1,i=window.questionCache[o].find(".message").is(":visible"),_.delay(function(t){return function(){var n;return!i&&(n=t.validateOne({key:o,autoscroll:!1,button:"<button type='button' data-name='"+o+"' class='validate_one'>Validate</button>"}),t.save(),t.updateSkipLogic(),t.actionOnChange(e),n)?t.autoscroll(e):void 0}}(this),500)))},QuestionView.prototype.onValidateOne=function(e){var t,n;return t=$(e.target),n=$(e.target).attr("data-name"),this.validateOne({key:n,autoscroll:!0,leaveMessage:!1,button:"<button type='button' data-name='"+n+"' class='validate_one'>Validate</button>"})},QuestionView.prototype.validateAll=function(){var e,t,n,i,o,a;for(e=!0,a=window.keyCache,i=0,o=a.length;o>i;i++)t=a[i],n=!this.validateOne({key:t,autoscroll:e,leaveMessage:!1}),e&&n&&(e=!1);return this.completeButton(e),e&&$("[name=complete]").parent().scrollTo(),e},QuestionView.prototype.validateOne=function(e){var t,n,i,o,a,r,u,s;r=e.key||"",i=e.autoscroll||!1,o=e.button||"<button type='button' class='next_error'>Next Error</button>",u=e.leaveMessage||!1,n=window.questionCache[r],t=n.find(".message");try{s=this.isValid(r)}catch(l){a=l,alert("isValid error in "+r+"\n"+a),s=""}return t.is(":visible")&&u?""===s?!0:!1:""===s?(t.hide(),i&&this.autoscroll(n),!0):(t.show().html(s+" "+o).find("button").button(),this.scrollToQuestion(n),!1)},QuestionView.prototype.isValid=function(e){var t,n,i,o,a,r,u,s,l,c,d;if(e){if(r=[],o=window.questionCache[e],o.hasClass("label"))return"";if(i=$("[name="+e+"]",o),u=$(o.find("input").get(0)).attr("type"),n="radio"===u?$("label[for="+i.attr("id").split("-")[0]+"]",o).text()||"":null!=(d=$("label[for="+i.attr("id")+"]",o))?d.text():void 0,a="true"===o.attr("data-required"),s=unescape(o.attr("data-validation")),"undefined"===s&&(s=null),c=window.getValueCache[e](),!o.is(":visible"))return"";if(0!==i.find("input").length&&("checkbox"===u||"radio"===u))return"";if("Location"!==e&&(!a||""!==c&&null!==c||r.push("'"+n+"' is required.")),null!=s&&""!==s)try{l=CoffeeScript.eval("(value) -> "+s,{bare:!0})(c),null!=l&&r.push(l)}catch(p){if(t=p,"invisible reference"===t)return"";alert("Validation error for "+e+" with value "+c+": "+t)}return 0!==r.length?r.join("<br>")+"<br>":""}},QuestionView.prototype.scrollToQuestion=function(e){return this.autoscroll($(e).prev())},QuestionView.prototype.autoscroll=function(e){var t,n,i;if(clearTimeout(this.autoscrollTimer),e.jquery?(t=e,window.scrollTargetName=t.attr("data-question-name")||t.attr("name")):(n=$(e.target),window.scrollTargetName=n.attr("name"),t=window.questionCache[window.scrollTargetName]),this.$next=t.next(),!this.$next.is(":visible")&&this.$next.length>0)for(i=0;!this.$next.is(":visible")&&(i+=1)<100;)this.$next=this.$next.next();if(this.$next.is(":visible")){if(window.questionCache[window.scrollTargetName].find(".message").is(":visible"))return;return $(window).on("scroll",function(e){return function(){return $(window).off("scroll"),clearTimeout(e.autoscrollTimer)}}(this)),this.autoscrollTimer=setTimeout(function(e){return function(){return $(window).off("scroll"),e.$next.scrollTo().find("input[type=text],input[type=number]").focus()}}(this),1e3)}},QuestionView.prototype.actionOnChange=function(e){var t,n,i,o,a,r,u,s,l;if(s=$(e.target).get(0).nodeName,n="INPUT"===s||"SELECT"===s||"TEXTAREA"===s?$(e.target):$(e.target).parent().parent().parent().find("input,textarea,select"),n.is(":visible")){r=n.attr("name"),t=$(".question [data-question-name="+r+"]"),i=t.attr("data-action_on_change");try{l=ResultOfQuestion(r)}catch(c){if(o=c,"invisible reference"===o)return}if(""!==i&&null!=i){i="(value) -> "+i;try{return(u=CoffeeScript.eval.apply(this,[i]))(l)}catch(c){return o=c,r=/function (.{1,})\(/.exec(o.constructor.toString())[1],a=o.message,alert("Action on change error in question "+(t.attr("data-question-id")||t.attr("id"))+"\n\n"+r+"\n\n"+a)}}}},QuestionView.prototype.updateSkipLogic=function(){var $question,error,message,name,result,skipLogicCode,_ref,_results;_ref=window.questionCache,_results=[];for(name in _ref)if($question=_ref[name],skipLogicCode=window.skipLogicCache[name],""!==skipLogicCode&&null!=skipLogicCode){try{result=eval(skipLogicCode)}catch(_error){error=_error,"invisible reference"===error?result=!0:(name=/function (.{1,})\(/.exec(error.constructor.toString())[1],message=error.message,alert("Skip logic error in question "+$question.attr("data-question-id")+"\n\n"+name+"\n\n"+message))}_results.push(result?$question[0].style.display="none":$question[0].style.display="")}return _results},QuestionView.prototype.save=_.throttle(function(){var e;return e=$("form").toObject({skipEmpty:!1}),e.lastModifiedAt=moment(new Date).format(Coconut.config.get("datetime_format")),e.savedBy=$.cookie("current_user"),this.result.save(e,{success:function(){return function(e){return $("#messageText").slideDown().fadeOut(),Coconut.router.navigate("edit/result/"+e.id,!1),Coconut.menuView.update()}}(this)})},1e3),QuestionView.prototype.completeButton=function(e){return this.changedComplete=!0,$("[name=complete]").prop("checked")!==e?$("[name=complete]").click():void 0},QuestionView.prototype.toHTMLForm=function(e,t){return null==e&&(e=this.model),window.skipLogicCache={},null==e.length&&(e=[e]),_.map(e,function(e){return function(n){var i,o,a,r,u,s,l,c;return c="true"===n.repeatable()?"<button>+</button>":"",null!=n.type()&&null!=n.label()&&""!==n.label()?(a=n.safeLabel(),window.skipLogicCache[a]=""!==n.skipLogic()?CoffeeScript.compile(n.skipLogic(),{bare:!0}):"",l=n.get("id"),"true"===n.repeatable()&&(a+="[0]",l=n.get("id")+"-0"),null!=t&&(a="group."+t+"."+a),"<div "+(n.validation()?n.validation()?"data-validation = '"+escape(n.validation())+"'":void 0:"")+" data-required='"+n.required()+"' class='question "+(("function"==typeof n.type?n.type():void 0)||"")+"' data-question-name='"+a+"' data-question-id='"+l+"' data-action_on_change='"+_.escape(n.actionOnChange())+"' > "+(~n.type().indexOf("hidden")?void 0:"<label type='"+n.type()+"' for='"+l+"'>"+n.label()+" <span></span></label>")+" <div class='message'></div> "+function(){var e,t,r;switch(n.type()){case"textarea":return"<input name='"+a+"' type='text' id='"+l+"' value='"+_.escape(n.value())+"'></input>";case"select":if(this.readonly)return n.value();for(i="<select>",r=n.get("select-options").split(/, */),o=e=0,t=r.length;t>e;o=++e)u=r[o],i+="<option name='"+a+"' id='"+l+"-"+o+"' value='"+u+"'>"+u+"</option>";return i+="</select>";case"radio":return this.readonly?"<input class='radioradio' name='"+a+"' type='text' id='"+l+"' value='"+n.value()+"'></input>":(s=n.get("radio-options"),_.map(s.split(/, */),function(e,t){return"<input class='radio' type='radio' name='"+a+"' id='"+l+"-"+t+"' value='"+_.escape(e)+"'/> <label class='radio' for='"+l+"-"+t+"'>"+e+"</label> <!-- <div class='ui-radio'> <label for=''"+l+"-"+t+"' data-corners='true' data-shadow='false' data-iconshadow='true' data-wrapperels='span' data-icon='radio-off' data-theme='c' class='ui-btn ui-btn-corner-all ui-btn-icon-left ui-radio-off ui-btn-up-c'> <span class='ui-btn-inner ui-btn-corner-all'> <span class='ui-btn-text'>"+e+"</span> <span class='ui-icon ui-icon-radio-off ui-icon-shadow'>&nbsp;</span> </span> </label> <input type='radio' name='"+a+"' id='"+l+"-"+t+"' value='"+_.escape(e)+"'/> </div> -->"}).join(""));case"checkbox":return this.readonly?"<input name='"+a+"' type='text' id='"+l+"' value='"+_.escape(n.value())+"'></input>":"<input style='display:none' name='"+a+"' id='"+l+"' type='checkbox' value='true'></input>";case"autocomplete from list":case"autocomplete from previous entries":case"autocomplete from code":return"<!-- autocomplete='off' disables browser completion --> <input autocomplete='off' name='"+a+"' id='"+l+"' type='"+n.type()+"' value='"+n.value()+"' data-autocomplete-options='"+n.get("autocomplete-options")+"'></input> <ul id='"+l+"-suggestions' data-role='listview' data-inset='true'/>";case"location":return"<a data-question-id='"+l+"'>Get current location</a> <label for='"+l+"-description'>Location Description</label> <input type='text' name='"+a+"-description' id='"+l+"-description'></input> "+_.map(["latitude","longitude"],function(e){return"<label for='"+l+"-"+e+"'>"+e+"</label><input readonly='readonly' type='number' name='"+a+"-"+e+"' id='"+l+"-"+e+"'></input>"}).join("")+" "+_.map(["altitude","accuracy","altitudeAccuracy","heading","timestamp"],function(e){return"<input type='hidden' name='"+a+"-"+e+"' id='"+l+"-"+e+"'></input>"}).join("");case"image":return"<img style='"+n.get("image-style")+"' src='"+n.get("image-path")+"'/>";case"label":return"";default:return"<input name='"+a+"' id='"+l+"' type='"+n.type()+"' value='"+n.value()+"'></input>"}}.call(e)+" </div> "+c):(r=l,n.repeatable()&&(r+="[0]"),"<div data-group-id='"+l+"' class='question group'>"+e.toHTMLForm(n.questions(),r)+"</div>"+c)}}(this)).join("")},QuestionView.prototype.updateCache=function(){var e,t,n,i,o,a,r,u,s,l;for(window.questionCache={},window.getValueCache={},window.$questions=$(".question"),l=window.$questions,u=0,s=l.length;s>u;u++)o=l[u],i=o.getAttribute("data-question-name"),null!=i&&""!==i&&(t={},window.questionCache[i]=$(o),e=window.questionCache[i],a=$("select[name="+i+"]",e),0===a.length?(n=$("input[name="+i+"]",e),0!==n.length?(r=n[0].getAttribute("type"),"radio"===r?!function(e,n){return t=function(){return $("input:checked",n).safeVal()}}(i,e):"checkbox"===r?!function(e,n){return t=function(){return $("input",n).map(function(){return $(this).safeVal()})}}(i,e):!function(e){return t=function(){return e.safeVal()}}(n)):!function(e,n){return t=function(){return $(".textarea[name="+e+"]",n).safeVal()}}(i,e)):!function(e){return t=function(){return e.safeVal()}}(a),window.getValueCache[i]=t);return window.keyCache=_.keys(questionCache)},QuestionView.prototype.repeat=function(e){var t,n,i,o,a,r,u,s,l,c;for(t=$(e.target),a=t.prev(".question").clone(),r=a.attr("data-group-id"),null==r&&(r=""),c=a.find("input"),s=0,l=c.length;l>s;s++)n=c[s],n=$(n),i=n.attr("name"),u=new RegExp(r+"\\[(\\d)\\]"),o=parseInt(_.last(i.match(u)))+1,n.attr("name",i.replace(u,r+"["+o+"]"));return t.after(a.add(t.clone())),t.remove()},QuestionView.prototype.getLocation=function(e){var t;return t=$(e.target).closest("[data-question-id]").attr("data-question-id"),$("#"+t+"-description").val("Retrieving position, please wait."),navigator.geolocation.getCurrentPosition(function(e){return function(n){return _.each(n.coords,function(e,n){return $("#"+t+"-"+n).val(e)}),$("#"+t+"-timestamp").val(moment(n.timestamp).format(Coconut.config.get("datetime_format"))),$("#"+t+"-description").val("Success"),e.save(),$.getJSON("http://api.geonames.org/findNearbyPlaceNameJSON?lat="+n.coords.latitude+"&lng="+n.coords.longitude+"&username=mikeymckay&callback=?",null,function(n){return $("#"+t+"-description").val(parseFloat(n.geonames[0].distance).toFixed(1)+" km from center of "+n.geonames[0].name),e.save()})}}(this),function(e){return $("#"+t+"-description").val("Error: "+e)},{frequency:1e3,enableHighAccuracy:!0,timeout:3e4,maximumAge:0})},QuestionView}(Backbone.View),function(e){return e.fn.scrollTo=function(t,n){var i;null==t&&(t=500);try{e("html, body").animate({scrollTop:e(this).offset().top+"px"},t,null,n)}catch(o){i=o,console.log("error",i),console.log("Scroll error with 'this'",this)}return this},e.fn.safeVal=function(){return this.is(":visible")||this.parents(".question").filter(function(){return!e(this).hasClass("group")}).is(":visible")?e.trim(this.val()||""):null}}($);
var MenuView,__bind=function(t,n){return function(){return t.apply(n,arguments)}},__extends=function(t,n){function e(){this.constructor=t}for(var r in n)__hasProp.call(n,r)&&(t[r]=n[r]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t},__hasProp={}.hasOwnProperty;MenuView=function(t){function n(){return this.render=__bind(this.render,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.el=".question-buttons",n.prototype.events={change:"render"},n.prototype.render=function(){return this.$el.html("<div id='navbar' data-role='navbar'> <ul></ul> </div>"),Coconut.questions.fetch({success:function(t){return function(){return t.$el.find("ul").html(Coconut.questions.map(function(t,n){return"<li><a id='menu-"+n+"' href='#show/results/"+escape(t.id)+"'><h2>"+t.id+"<div id='menu-partial-amount'></div></h2></a></li>"}).join(" ")),$(".question-buttons").navbar(),t.update()}}(this)})},n.prototype.update=function(){return Coconut.questions.each(function(){return function(t,n){var e;return e=new ResultCollection,e.fetch({include_docs:!1,question:t.id,isComplete:!1,success:function(){return $("#menu-"+n+" #menu-partial-amount").html(e.length)}})}}(this)),$.ajax("app/version",{success:function(t){return $("#version").html(t)},error:$("#version").html("-")})},n}(Backbone.View);
var ResultsView,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__hasProp={}.hasOwnProperty,__extends=function(t,e){function n(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t};ResultsView=function(t){function e(){return this.render=__bind(this.render,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.initialize=function(){return this.question=new Question},e.prototype.el="#content",e.prototype.render=function(){return this.$el.html("<style> table.results th.header, table.results td{ font-size:150%; } </style> <div class='not-complete' data-collapsed='false' data-role='collapsible'> <h2>'"+this.question.id+"' Items Not Completed (<span class='count-complete-false'></span>)</h2> <table class='results complete-false tablesorter'> <thead><tr>"+_.map(this.question.summaryFieldNames(),function(t){return"<th class='header'>"+t+"</th>"}).join("")+("<th></th> </tr></thead> <tbody> </tbody> </table> <a href='#new/result/"+escape(this.question.id)+"'>Add new '"+this.question.id+"'</a> </div> <div class='complete' data-role='collapsible'> <h2>'"+this.question.id+"' Items Completed (<span class='count-complete-true'></span>)</h2> <table class='results complete-true tablesorter'> <thead><tr>")+_.map(this.question.summaryFieldNames(),function(t){return"<th class='header'>"+t+"</th>"}).join("")+"<th></th> </tr></thead> <tbody> </tbody> </table> </div>"),$("a").button(),$("table").tablesorter(),$("table").addTableFilter({labelText:null}),$("input[type=search]").textinput(),$("[data-role=collapsible]").collapsible(),this.loadIncompleteResults(),$(".complete").bind("expand",function(t){return function(){return $(".complete tr td").length>0?void 0:t.loadCompleteResults()}}(this)),this.updateCountComplete()},e.prototype.updateCountComplete=function(){var t;return t=new ResultCollection,t.fetch({include_docs:!1,question:this.question.id,isComplete:!0,success:function(){return function(){return $(".count-complete-true").html(t.length)}}(this)})},e.prototype.loadIncompleteResults=function(){return this.loadResults(!1)},e.prototype.loadCompleteResults=function(){return this.loadResults(!0)},e.prototype.loadResults=function(t){var e;return e=new ResultCollection,e.fetch({include_docs:!0,question:this.question.id,isComplete:t,success:function(n){return function(){return $(".count-complete-"+t).html(e.length),e.each(function(o,s){return $("table.complete-"+t+" tbody").append("<tr> "+_.map(o.summaryValues(n.question),function(t){return"<td><a href='#edit/result/"+o.id+"'>"+t+"</a></td>"}).join("")+" <td><a href='#delete/result/"+o.id+"' data-icon='delete' data-iconpos='notext'>Delete</a></td> </tr>"),s+1===e.length&&($("table a").button(),$("table").trigger("update")),_.each($("table tr"),function(t,e){return e%2===1?$(t).addClass("odd"):void 0})})}}(this)})},e}(Backbone.View);
var ResultSummaryEditorView,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__extends=function(t,e){function r(){this.constructor=t}for(var o in e)__hasProp.call(e,o)&&(t[o]=e[o]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},__hasProp={}.hasOwnProperty;ResultSummaryEditorView=function(t){function e(){return this.render=__bind(this.render,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.initialize=function(){},e.prototype.el=$("#content"),e.prototype.events={"submit #resultSummaryEditor form":"save"},e.prototype.save=function(){return this.question.set({resultSummaryFields:$("form").toObject()}),this.question.save(),!1},e.prototype.render=function(){var t;return t="<div id='resultSummaryEditor'> Check the boxes to use for summarizing results for <b>"+this.question.id+"</b>:<br/> <form> <ul>",_.each(this.question.questions(),function(e,r){return t+="<li> <input id='result-summary-option-"+r+"' name='"+e.label()+"' type='checkbox'></input> <label for='result-summary-option-"+r+"'>"+e.label()+"</label> </li>"}),t+="</ul> <input type='submit' value='Save'></input> </form> </div>",this.$el.html(t),console.log(this.question),js2form($("form").get(0),this.question.resultSummaryFields())},e}(Backbone.View);
var SyncView,__bind=function(t,n){return function(){return t.apply(n,arguments)}},__extends=function(t,n){function e(){this.constructor=t}for(var s in n)__hasProp.call(n,s)&&(t[s]=n[s]);return e.prototype=n.prototype,t.prototype=new e,t.__super__=n.prototype,t},__hasProp={}.hasOwnProperty;SyncView=function(t){function n(){return this.update=__bind(this.update,this),this.render=__bind(this.render,this),n.__super__.constructor.apply(this,arguments)}return __extends(n,t),n.prototype.initialize=function(){return this.sync=new Sync},n.prototype.el="#content",n.prototype.render=function(){return this.$el.html("<h2>Cloud Server: <span class='sync-target'>"+this.sync.target()+"</span></h2> <a href='#sync/send'>Send data (last done: <span class='sync-sent-status'></span>)</a> <a href='#sync/get'>Get data (last done: <span class='sync-get-status'></span>)</a>"),$("a").button(),this.update()},n.prototype.update=function(){return this.sync.fetch({success:function(t){return function(){return $(".sync-sent-status").html(t.sync.was_last_send_successful()?t.sync.last_send_time():t.sync.last_send_time()+" - last attempt FAILED"),$(".sync-get-status").html(t.sync.was_last_get_successful()?t.sync.last_get_time():t.sync.last_get_time()+" - last attempt FAILED")}}(this),error:function(t){return function(){return console.log("synclog doesn't exist yet, create it and re-render"),t.sync.save(),_.delay(t.update,1e3)}}(this)})},n}(Backbone.View);
var ManageView,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__extends=function(t,e){function r(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},__hasProp={}.hasOwnProperty;ManageView=function(t){function e(){return this.render=__bind(this.render,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.el="#content",e.prototype.render=function(){return this.$el.html("<a href='#sync'>Sync</a> <a href='#configure'>Set cloud vs mobile</a> <a href='#users'>Manage users</a> <a href='#messaging'>Send message to users</a> <h2>Question Sets</h2> <a href='#design'>New</a> <table> <thead> <th></th> <th></th> <th></th> <th></th> </thead> <tbody> </tbody> </table>"),$("a").button(),Coconut.questions.fetch({success:function(){return Coconut.questions.each(function(t){var e,r;return r=t.id,e=escape(t.id),$("tbody").append("<tr> <td>"+r+"</td> <td><a href='#edit/"+e+"'>edit</a></td> <td><a href='#delete/"+e+"'>delete</a></td> <td><a href='#edit/resultSummary/"+e+"'>summary</a></td> </tr>")}),$("table a").button()}})},e}(Backbone.View);
var LocalConfigView,__extends=function(e,o){function t(){this.constructor=e}for(var n in o)__hasProp.call(o,n)&&(e[n]=o[n]);return t.prototype=o.prototype,e.prototype=new t,e.__super__=o.prototype,e},__hasProp={}.hasOwnProperty;LocalConfigView=function(e){function o(){return o.__super__.constructor.apply(this,arguments)}return __extends(o,e),o.prototype.el="#content",o.prototype.render=function(){var e;return this.$el.html("<form id='local-config'> <h1>Configure your Coconut system</h1> <label>Coconut Cloud URL</label> <input type='text' name='coconut-cloud' value='http://'></input> <fieldset id='mode-fieldset'> <legend>Mode</legend> <label for='cloud'>Cloud (reporting system)</label> <input id='cloud' name='mode' type='radio' value='cloud'></input> <label for='mobile'>Mobile (data collection, probably on a tablet)</label> <input id='mobile' name='mode' type='radio' value='mobile'></input> </fieldset> <button>Save</button> <div id='message'></div> </form>"),null==Coconut.config.get("mode")&&($("#mode-fieldset").hide(),$("#mobile").prop("checked",!0)),this.$el.find("input[type=radio],input[type=checkbox]").checkboxradio(),this.$el.find("button").button(),this.$el.find("input[type=text]").textinput(),null!=(e=Coconut.config.local)?e.fetch({success:function(){return js2form($("#local-config").get(0),Coconut.config.local.toJSON())},error:function(){return $("#message").html("Complete the fields before continuing")}}):void 0},o.prototype.events={"click #local-config button":"save"},o.prototype.save=function(){var e,o,t;return t=$("#local-config").toObject(),e=$("input[name=coconut-cloud]").val(),o=e+"/coconut.config",t.mode&&null!=e?($("#message").html("Downloading configuration file from "+o+"<br/>"),$.ajax({url:o,dataType:"jsonp",success:function(e){return $("#message").append("Saving configuration file<br/>"),delete e._rev,Coconut.config.save(e,{success:function(){return $("#message").append("Creating local configuration file<br/>"),t=new LocalConfig,t.fetch({complete:function(){return t.save(t,{success:function(){var e;return $("#message").append("Local configuration file saved<br/>"),e=new Sync,e.save(null,{success:function(){return $("#message").append("Updating application<br/>"),e.getFromCloud({success:function(){return Coconut.router.navigate("",!1),location.reload()}})}})}})}})}})},error:function(){return console.log("Couldn't find config file at "+o)}}),!1):($("#message").html("Fields incomplete"),!1)},o}(Backbone.View);
var ReportView,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__extends=function(t,e){function r(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},__hasProp={}.hasOwnProperty;ReportView=function(t){function e(){return this.deliveryReports=__bind(this.deliveryReports,this),this.spreadsheet=__bind(this.spreadsheet,this),this.render=__bind(this.render,this),this.update=__bind(this.update,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.initialize=function(){return $("html").append("<link href='js-libraries/Leaflet/leaflet.css' type='text/css' rel='stylesheet' /> <script type='text/javascript' src='js-libraries/Leaflet/leaflet.js'></script> <style> .dissaggregatedResults{ display: none; } </style>")},e.prototype.el="#content",e.prototype.events={"change #reportOptions":"update","change #summaryField":"summarize","change #aggregateBy":"update","click #toggleDisaggregation":"toggleDisaggregation"},e.prototype.update=function(){var t,e;return t={startDate:$("#start").val(),endDate:$("#end").val(),reportType:$("#report-type :selected").text(),question:$("#selected-question :selected").text(),aggregateBy:$("#aggregateBy :selected").text()},_.each(this.locationTypes,function(e){return t[e]=$("#"+e+" :selected").text()}),e="reports/"+_.map(t,function(t,e){return e+"/"+escape(t)}).join("/"),Coconut.router.navigate(e,!0)},e.prototype.render=function(t){return this.reportType=t.reportType||"results",this.startDate=t.startDate||moment(new Date).subtract("days",14).format("YYYY-MM-DD"),this.endDate=t.endDate||moment(new Date).format("YYYY-MM-DD"),this.question=unescape(t.question),this.aggregateBy=t.aggregateBy||"District",this.$el.html("<style> table.results th.header, table.results td{ font-size:150%; } </style> <table id='reportOptions'></table>"),Coconut.questions.fetch({success:function(t){return function(){return $("#reportOptions").append(t.formFilterTemplate({id:"question",label:"Question",form:"<select id='selected-question'> "+Coconut.questions.map(function(e){return"<option "+(e.label()===t.question?"selected='true'":"")+">"+e.label()+"</option>"}).join("")+" </select>"})),$("#reportOptions").append(t.formFilterTemplate({id:"start",label:"Start Date",form:"<input id='start' type='date' value='"+t.startDate+"'/>"})),$("#reportOptions").append(t.formFilterTemplate({id:"end",label:"End Date",form:"<input id='end' type='date' value='"+t.endDate+"'/>"})),$("#reportOptions").append(t.formFilterTemplate({id:"report-type",label:"Report Type",form:"<select id='report-type'> "+_.map(["spreadsheet","results","summarytables","deliveryReports"],function(e){return"<option "+(e===t.reportType?"selected='true'":void 0)+">"+e+"</option>"}).join("")+" </select>"})),t[t.reportType](),$("div[data-role=fieldcontain]").fieldcontain(),$("select").selectmenu(),$("input[type=date]").datebox({mode:"calbox"})}}(this)})},e.prototype.hierarchyOptions=function(t,e){return"region"===t?_.keys(WardHierarchy.hierarchy):_.chain(WardHierarchy.hierarchy).map(function(r,n){return"district"===t&&e===n?_.keys(r):_.map(r,function(r,n){return"constituan"===t&&e===n?_.keys(r):_.map(r,function(r,n){return"shehia"===t&&e===n?r:void 0})})}).flatten().compact().value()},e.prototype.mostSpecificLocationSelected=function(){var t,e;return t="region",e="ALL",_.each(this.locationTypes,function(r){return"ALL"!==this[r]?(t=r,e=this[r]):void 0}),{type:t,name:e}},e.prototype.formFilterTemplate=function(t){return"<tr> <td> <label style='display:inline' for='"+t.id+"'>"+t.label+"</label> </td> <td style='width:150%'> "+t.form+" </select> </td> </tr>"},e.prototype.viewQuery=function(t){var e;return e=new ResultCollection,e.fetch({question:$("#selected-question").val(),isComplete:!0,include_docs:!0,success:function(){return e.fields={},e.each(function(t){return _.each(_.keys(t.attributes),function(t){return _.contains(["_id","_rev","question"],t)?void 0:e.fields[t]=!0})}),e.fields=_.keys(e.fields),t.success(e)}})},e.prototype.spreadsheet=function(){return this.viewQuery({success:function(t){return function(e){var r;return r=e.map(function(t){return _.map(e.fields,function(e){return t.get(e)}).join(",")}).join("\n"),t.$el.append("<a id='csv' href='data:text/octet-stream;base64,"+Base64.encode(e.fields.join(",")+"\n"+r)+"' download='"+(t.startDate+"-"+t.endDate)+".csv'>Download spreadsheet</a>"),$("a#csv").button()}}(this)})},e.prototype.results=function(){return this.$el.append("<hr/> <table id='results' class='tablesorter'> <thead> <tr> </tr> </thead> <tbody> </tbody> </table>"),this.viewQuery({success:function(){return function(t){var e;return e={},$.couch.db(Coconut.config.database_name()).view(Coconut.config.design_doc_name()+"/deliveryReportsByDate",{include_docs:!0,success:function(r){return _(r.rows).each(function(r){var n,o,i;return n=r.doc,i=n.Region+"-"+n.District+"-"+n.Ward+"-"+n.Village+"-"+n.Name+"-"+n.Type,e[i]=n["Number of Nets"],o=t.map(function(e){return _.map(t.fields,function(t){return e.get(t)})}),$("table#results thead tr").append(""+_.map(t.fields,function(t){return"<th>"+t+"</th>"}).join("")),$("table#results tbody").append(_.map(o,function(t){return"<tr> "+_.map(t,function(t){return"<td>"+t+"</td>"}).join("")+" </tr>"}).join("")),_.each($("table tr"),function(t,e){return e%2===1?$(t).addClass("odd"):void 0}),$("table#results").dataTable({aaSorting:[[0,"desc"]],iDisplayLength:25,dom:'T<"clear">lfrtip',tableTools:{sSwfPath:"js-libraries/copy_csv_xls_pdf.swf"}})})}})}}(this)})},e.prototype.summarytables=function(){return Coconut.resultCollection.fetch({includeData:!0,success:function(t){return function(){var e;return e=_.chain(Coconut.resultCollection.toJSON()).map(function(t){return _.keys(t)}).flatten().uniq().sort().value(),e=_.without(e,"_id","_rev"),t.$el.append("<br/> Choose a field to summarize:<br/> <select id='summaryField'> "+_.map(e,function(t){return"<option id='"+t+"'>"+t+"</option>"}).join("")+" </select>"),$("select").selectmenu()}}(this)})},e.prototype.deliveryReports=function(){var t;return t="Region,District,School".split(/,/),$("#reportOptions tr").first().hide(),this.$el.append("<br/> <hr/> Choose a field to aggregate by:<br/> <select id='aggregateBy'> "+_.map(t,function(t){return function(e){return"<option id='"+e+"' "+(t.aggregateBy===e?"selected='true'":"")+">"+e+"</option>"}}(this)).join("")+" </select> <br/>"),$.couch.db(Coconut.config.database_name()).view(Coconut.config.design_doc_name()+"/deliveryReportsByDate",{include_docs:!0,startkey:this.startDate,endkey:this.endDate,success:function(e){return function(r){var n,o,i,s;return n={},_(t).each(function(t){return n[t]={}}),o={},_(r.rows).each(function(e){var r,i;return r=e.doc,i=r.Region+"-"+r.District+"-"+r.Ward+"-"+r.Village+"-"+r.Name+"-"+r.Type,o[i]?void 0:(o[i]=!0,_(t).each(function(t){var e;return null==n[t][r[t]]&&(n[t][r[t]]={"Number of Nets":0,Region:r.Region}),"School"===t?(e=r.District+"i-"+r.Village+"-"+r.Name+"-"+r.Type,n[t][e]={"Number of Nets":0,Region:r.Region}):e=r[t],("District"===t||"School"===t)&&(n[t][e].District=r.District),"School"===t&&(n[t][e].Ward=r.Ward),"School"===t&&(n[t][e].Village=r.Village),"School"===t&&(n[t][e].School=r.Name),"School"===t&&(n[t][e].Type=r.Type),n[t][e]["Number of Nets"]+=parseInt(r["Number of Nets"])}))}),console.log(n),e.$el.append("<table id='results' class='tablesorter'> <thead> "+("School"===e.aggregateBy?s=["Region","District","Ward","School","Type","Number of Nets"]:(i=_(n[e.aggregateBy]).find(function(){return!0}),s=_(i).keys()),_(s).map(function(t){return"<th>"+t+"</th>"}).join(""))+" </thead> <tbody> "+_(n[e.aggregateBy]).map(function(t){return"<tr> "+_(s).map(function(e){return"<td>"+t[""+e]+"</td>"}).join("")+" </tr>"}).join("")+" </tbody> </table>"),$("#results").dataTable({aaSorting:[[0,"desc"]],iDisplayLength:25,dom:'T<"clear">lfrtip',tableTools:{sSwfPath:"js-libraries/copy_csv_xls_pdf.swf"}})}}(this)})},e.prototype.summarize=function(){var t;return t=$("#summaryField option:selected").text(),this.viewQuery({success:function(e){return function(r){var n;return n={},r.each(function(e){return _.each(e.toJSON(),function(r,o){return o===t?null!=n[r]?(n[r].sums+=1,n[r].resultIDs.push(e.get("_id"))):(n[r]={},n[r].sums=1,n[r].resultIDs=[],n[r].resultIDs.push(e.get("_id"))):void 0})}),console.log(n),e.$el.append("<h2>"+t+"</h2> <table id='summaryTable' class='tablesorter'> <thead> <tr> <th>Value</th> <th>Total</th> </tr> </thead> <tbody> "+_.map(n,function(t,e){return"<tr> <td>"+e+"</td> <td> <button id='toggleDisaggregation'>"+t.sums+"</button> </td> <td class='dissaggregatedResults'> "+_.map(t.resultIDs,function(t){return t}).join(", ")+" </td> </tr>"}).join("")+" </tbody> </table>"),$("button").button(),$("a").button(),_.each($("table tr"),function(t,e){return e%2===1?$(t).addClass("odd"):void 0})}}(this)})},e.prototype.toggleDisaggregation=function(){return $(".dissaggregatedResults").toggle()},e}(Backbone.View);
var CaseView,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__extends=function(t,e){function n(){this.constructor=t}for(var r in e)__hasProp.call(e,r)&&(t[r]=e[r]);return n.prototype=e.prototype,t.prototype=new n,t.__super__=e.prototype,t},__hasProp={}.hasOwnProperty;CaseView=function(t){function e(){return this.render=__bind(this.render,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.el="#content",e.prototype.render=function(){return this.$el.html("<h1>Case ID: "+this["case"].MalariaCaseID()+"</h1> <h2>Last Modified: "+this["case"].LastModifiedAt()+"</h2> <h2>Questions: "+this["case"].Questions()+"</h2> "+_.map("region,district,constituan,ward".split(","),function(t){return function(e){return"<h2>"+e.humanize()+": "+t["case"].location(e)+"</h2>"}}(this)).join("")+" <pre> "+JSON.stringify(this["case"].toJSON(),null,4)+" </pre>")},e}(Backbone.View);
var UsersView,__bind=function(t,e){return function(){return t.apply(e,arguments)}},__extends=function(t,e){function r(){this.constructor=t}for(var n in e)__hasProp.call(e,n)&&(t[n]=e[n]);return r.prototype=e.prototype,t.prototype=new r,t.__super__=e.prototype,t},__hasProp={}.hasOwnProperty;UsersView=function(t){function e(){return this.render=__bind(this.render,this),e.__super__.constructor.apply(this,arguments)}return __extends(e,t),e.prototype.initialize=function(){return this.userCollection=new UserCollection},e.prototype.el="#content",e.prototype.events={"submit form#user":"save","click .loadUser":"load"},e.prototype.save=function(){var t,e;return e=$("#user").toObject({skipEmpty:!1}),e._id="user."+e._id,t=new User({_id:e._id}),console.log(e),t.fetch({success:function(r){return function(){return t.save(e,{success:function(){return r.render()}})}}(this),error:function(r){return function(){return t.save(e,{success:function(){return r.render()}})}}(this)}),!1},e.prototype.load=function(t){var e;return e=new User({_id:$(t.target).closest("a").attr("data-user-id")}),e.fetch({success:function(){return function(){return e.set({_id:e.get("_id").replace(/user\./,"")}),js2form($("#user").get(0),e.toJSON())}}(this)}),!1},e.prototype.render=function(){var t;return t="_id,password,district,name,comments".split(","),this.$el.html("<h2>Create/edit users</h2> <h3>Use phone number for username to enable SMS messages</h3> <form id='user'> "+_.map(t,function(t){return"<label style='display:block' for='"+t+"'>"+("_id"===t?"Username":t.humanize())+"</label> <input id='"+t+"' name='"+t+"' type='text'></input>"}).join("")+" <input type='submit'></input> </form> <h2>Click username to edit</h2> <table> <thead> "+_.map(t,function(t){return"<th>"+("_id"===t?"Username":t.humanize())+"</th>"}).join("")+" </thead> <tbody> </tbody> </table>"),this.userCollection.fetch({success:function(e){return function(){return e.userCollection.sortBy(function(t){return t.get("_id")}).forEach(function(e){return $("tbody").append("<tr> "+_.map(t,function(t){var r;return r=e.get(t),"_id"===t?"<td><a class='loadUser' data-user-id='"+e.get("_id")+"' href=''>"+r.replace(/user\./,"")+"</a></td>":"<td>"+r+"</td>"}).join("")+" </tr>")}),$("a").button()}}(this)}),$("table").addTableFilter({labelText:null}),$("input[type=search]").textinput()},e}(Backbone.View);
var MessagingView,__bind=function(e,t){return function(){return e.apply(t,arguments)}},__extends=function(e,t){function n(){this.constructor=e}for(var r in t)__hasProp.call(t,r)&&(e[r]=t[r]);return n.prototype=t.prototype,e.prototype=new n,e.__super__=t.prototype,e},__hasProp={}.hasOwnProperty;MessagingView=function(e){function t(){return this.render=__bind(this.render,this),this.checkAll=__bind(this.checkAll,this),t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.initialize=function(){return this.userCollection=new UserCollection,this.messageCollection=new MessageCollection,this.max=140},t.prototype.el="#content",t.prototype.events={"click #check-all":"checkAll","click .phone-number":"updateToField","click input[value=Send]":"send","keyup #message":"checkLength"},t.prototype.checkLength=function(){return $("#charCount").html("Characters used: "+$("#message").val().length+". Maximum allowed: 140"),$("#message").val().length>this.max?$("#charCount").css("color","red"):$("#charCount").css("color","")},t.prototype.send=function(){var e;return e=$("#message").val(),e.length>this.max||0===e.length?!1:(_.each(this.phoneNumbers,function(t){var n;return n=new Message({date:moment(new Date).format(Coconut.config.get("date_format")),text:e,to:t}),n.sendSMS({success:function(){return n.save(),$("#messageBox").append("Sent '"+e+"' to "+t)},error:function(n){return $("#messageBox").append("Error: ["+n+"] while sending '"+e+"' to "+t)}})}),!1)},t.prototype.checkAll=function(){return $("input[type=checkbox].phone-number").attr("checked",$("#check-all").is(":checked")),this.updateToField()},t.prototype.updateToField=function(){return this.phoneNumbers=_.map($("input[type=checkbox].phone-number:checked"),function(e){return $(e).attr("id").replace(/check-user\./,"")}),$("#to").html(this.phoneNumbers.join(", "))},t.prototype.render=function(){var e,t;return e="_id,district,name,comments".split(","),t="date,to,text".split(","),this.$el.html("<h2>Send Message</h2> <h3>Select Recipients</h2> <table class='recipients'> <thead> <th></th> "+_.map(e,function(e){return"<th>"+("_id"===e?"Phone Number":e.humanize())+"</th>"}).join("")+" </thead> <tbody> </tbody> </table> <form id='message-form'> Recipients: <div id='to'></div> <label style='display:block' for='message'>Message</label> <textarea style='width:100%' id='message' name='message'></textarea> <div id='messageBox'></div> </div> <input type='submit' value='Send'></input> <span id='charCount'></span> </form> <h3>Sent Messages</h3> <table class='sent-messages'> <thead> "+_.map(t,function(e){return"<th>"+e+"</th>"}).join("")+" </thead> <tbody> </tbody> </table>"),this.userCollection.fetch({success:function(t){return function(){return $("table.recipients").before("<input id='check-all' type='checkbox'></input>Select All"),t.userCollection.sortBy(function(e){return e.get("district")}).forEach(function(t){return t.get("_id").match(/\d\d\d/)?$(".recipients tbody").append("<tr> <td><input class='phone-number' id='check-"+t.get("_id")+"' type='checkbox'></input></td> "+_.map(e,function(e){var n;return n=t.get(e),"_id"===e&&(n=n.replace(/user\./,"")),"<td>"+n+"</td>"}).join("")+" </tr>"):void 0}),$(".recipients tbody").append("<tr> <td><input class='phone-number' id='check-user.0787263670' type='checkbox'></input></td> <td>0787263670</td> <td></td> <td>Ritha</td> <td>RTI</td> </tr> <tr> <td><input class='phone-number' id='check-user.3141' type='checkbox'></input></td> <td>31415926</td> <td></td> <td>Test</td> <td>Doesn't actually work</td> </tr>"),$("a").button()}}(this)}),this.messageCollection.fetch({success:function(e){return function(){return e.messageCollection.forEach(function(e){return $(".sent-messages tbody").append("<tr> "+_.map(t,function(t){return"<td>"+e.get(t)+"</td>"}).join("")+" </tr>")})}}(this)})},t}(Backbone.View);
var HelpView,__extends=function(e,t){function o(){this.constructor=e}for(var n in t)__hasProp.call(t,n)&&(e[n]=t[n]);return o.prototype=t.prototype,e.prototype=new o,e.__super__=t.prototype,e},__hasProp={}.hasOwnProperty;HelpView=function(e){function t(){return t.__super__.constructor.apply(this,arguments)}return __extends(t,e),t.prototype.el="#content",t.prototype.events={"click input[value=Send]":"send"},t.prototype.render=function(){return this.$el.html("<label style='display:block' for='message'>If you are having trouble please contact your supervisor as soon as possible. You can also describe the problem in the box below and it will send a message to our support team. We'll get back to you as soon as possible.</label> <textarea style='width:100%' id='message' name='message'></textarea> <div id='messageBox'></div> </div> <input type='submit' value='Send'></input>")},t.prototype.send=function(){var e,t,o;return t=$("#message").val(),0===t.length?!1:(e=new Help({date:moment(new Date).format(Coconut.config.get("date_format")),text:t,user:User.currentUser.id.replace(/user\./,"")}),e.save(),o=new Sync,$("#messageBox").append("Attempting to 'Send Data'"),o.sendToCloud({success:function(){return $("#messageBox").append("Thank you for your feedback, it has been sent")},error:function(){return $("#messageBox").append("There was a problem sending data, but your messages has been saved. If you have connectivity you can try again by pressing the 'Send data' button at the bottom of the screen.")}}),!1)},t}(Backbone.View);
var Coconut,Router,__extends=function(e,n){function t(){this.constructor=e}for(var o in n)__hasProp.call(n,o)&&(e[o]=n[o]);return t.prototype=n.prototype,e.prototype=new t,e.__super__=n.prototype,e},__hasProp={}.hasOwnProperty;Router=function(e){function n(){return n.__super__.constructor.apply(this,arguments)}return __extends(n,e),n.prototype.routes={login:"login",logout:"logout",design:"design",select:"select","show/results/:question_id":"showResults","new/result/:question_id":"newResult","edit/result/:result_id":"editResult","delete/result/:result_id":"deleteResult","delete/result/:result_id/:confirmed":"deleteResult","edit/resultSummary/:question_id":"editResultSummary","analyze/:form_id":"analyze","delete/:question_id":"deleteQuestion","edit/:question_id":"editQuestion",manage:"manage",sync:"sync","sync/send":"syncSend","sync/get":"syncGet",configure:"configure",map:"map",reports:"reports","reports/*options":"reports",alerts:"alerts","show/case/:caseID":"showCase",users:"users",messaging:"messaging",help:"help","":"default"},n.prototype.route=function(e,n,t){return Backbone.history||(Backbone.history=new Backbone.History),_.isRegExp(e)||(e=this._routeToRegExp(e)),Backbone.history.route(e,function(o){return function(u){var s;return s=o._extractParameters(e,u),t.apply(o,s),$("#loading").slideDown(),o.trigger.apply(o,["route:"+n].concat(s)),$("#loading").fadeOut()}}(this),this)},n.prototype.help=function(){return this.userLoggedIn({success:function(){return null==Coconut.helpView&&(Coconut.helpView=new HelpView),Coconut.helpView.render()}})},n.prototype.users=function(){return this.adminLoggedIn({success:function(){return null==Coconut.usersView&&(Coconut.usersView=new UsersView),Coconut.usersView.render()}})},n.prototype.messaging=function(){return this.adminLoggedIn({success:function(){return null==Coconut.messagingView&&(Coconut.messagingView=new MessagingView),Coconut.messagingView.render()}})},n.prototype.login=function(){return Coconut.loginView.callback={success:function(){return Coconut.router.navigate("",!0)}},Coconut.loginView.render()},n.prototype.userLoggedIn=function(e){return User.isAuthenticated({success:function(n){return e.success(n)},error:function(){return Coconut.loginView.callback=e,Coconut.loginView.render()}})},n.prototype.adminLoggedIn=function(e){return this.userLoggedIn({success:function(n){return n.isAdmin()?e.success(n):void 0},error:function(){return $("#content").html("<h2>Must be an admin user</h2>")}})},n.prototype.logout=function(){return User.logout(),Coconut.router.navigate("",!0)},n.prototype["default"]=function(){return this.userLoggedIn({success:function(){return $("#content").html("<!-- Reported/Facility Followup/Household Followup/#Tested/ (Show for Same period last year) For completed cases, average time between notification and household followup Last seven days Last 30 days Last 365 days Current month Current year Total --> <table class='summary tablesorter'> <thead><tr> <th>Question</th> <th>Not Completed</th> <th>Completed</th> </tr></thead> <tbody> </tbody> </table>"),Coconut.questions.each(function(){return function(e,n){return $("#content table tbody").append("<tr id='"+e.attributeSafeText()+"'><td>"+e.get("id")+"</td></tr>"),_.each(["false","true"],function(n){var t;return t=new ResultCollection,t.fetch({question:e.id,isComplete:n,success:function(){return function(){return $("tr#"+e.attributeSafeText()).append("<td>"+t.length+"</td>")}}(this)})}),n+1===Coconut.questions.length&&($("table").tablesorter(),$("table a").button(),$("table").trigger("update")),_.each($("table tr"),function(e,n){return n%2===1?$(e).addClass("odd"):void 0})}}(this))}})},n.prototype.alerts=function(){return this.userLoggedIn({success:function(){return $("#content").html("mobile"===Coconut.config.local.mode?"Alerts not available in mobile mode.":"<h1>Alerts</h1> <ul> <li> <b>Localised Epidemic</b>: More than 10 cases per square kilometer in KATI district near BAMBI shehia (map <a href='#reports/location'>Map</a>). Recommend active case detection in shehia. </li> <li> <b>Abnormal Data Detected</b>: Only 1 case reported in MAGHARIBI district for June 2012. Expected amount: 25. Recommend checking that malaria test kits are available at all health facilities in MAGHARIBI. </li> </ul>")}})},n.prototype.reports=function(e){return this.userLoggedIn({success:function(){var n;return"mobile"===Coconut.config.local.mode?$("#content").html("Reports not available in mobile mode."):(e=null!=e?e.split(/\//):void 0,n={},_.each(e,function(t,o){return o%2?void 0:n[t]=e[o+1]}),null==Coconut.reportView&&(Coconut.reportView=new ReportView),Coconut.reportView.render(n))}})},n.prototype.showCase=function(e){return this.userLoggedIn({success:function(){return null==Coconut.caseView&&(Coconut.caseView=new CaseView),Coconut.caseView["case"]=new Case({caseID:e}),Coconut.caseView["case"].fetch({success:function(){return Coconut.caseView.render()}})}})},n.prototype.configure=function(){return this.userLoggedIn({success:function(){return null==Coconut.localConfigView&&(Coconut.localConfigView=new LocalConfigView),Coconut.localConfigView.render()}})},n.prototype.editResultSummary=function(e){return this.userLoggedIn({success:function(){return null==Coconut.resultSummaryEditor&&(Coconut.resultSummaryEditor=new ResultSummaryEditorView),Coconut.resultSummaryEditor.question=new Question({id:unescape(e)}),Coconut.resultSummaryEditor.question.fetch({success:function(){return Coconut.resultSummaryEditor.render()}})}})},n.prototype.editQuestion=function(e){return this.userLoggedIn({success:function(){return null==Coconut.designView&&(Coconut.designView=new DesignView),Coconut.designView.render(),Coconut.designView.loadQuestion(unescape(e))}})},n.prototype.deleteQuestion=function(e){return this.userLoggedIn({success:function(){return Coconut.questions.get(unescape(e)).destroy({success:function(){return Coconut.menuView.render(),Coconut.router.navigate("manage",!0)}})}})},n.prototype.sync=function(){return this.userLoggedIn({success:function(){return null==Coconut.syncView&&(Coconut.syncView=new SyncView),Coconut.syncView.render()}})},n.prototype.syncSend=function(){return Coconut.router.navigate("",!1),this.userLoggedIn({success:function(){return null==Coconut.syncView&&(Coconut.syncView=new SyncView),Coconut.syncView.sync.sendToCloud({success:function(){return Coconut.syncView.update()}})}})},n.prototype.syncGet=function(){return Coconut.router.navigate("",!1),this.userLoggedIn({success:function(){return null==Coconut.syncView&&(Coconut.syncView=new SyncView),Coconut.syncView.sync.getFromCloud()}})},n.prototype.manage=function(){return this.adminLoggedIn({success:function(){return null==Coconut.manageView&&(Coconut.manageView=new ManageView),Coconut.manageView.render()}})},n.prototype.newResult=function(e){return this.userLoggedIn({success:function(){return null==Coconut.questionView&&(Coconut.questionView=new QuestionView),Coconut.questionView.result=new Result({question:unescape(e)}),Coconut.questionView.model=new Question({id:unescape(e)}),Coconut.questionView.model.fetch({success:function(){return Coconut.questionView.render()}})}})},n.prototype.editResult=function(e){return this.userLoggedIn({success:function(){return null==Coconut.questionView&&(Coconut.questionView=new QuestionView),Coconut.questionView.readonly=!1,Coconut.questionView.result=new Result({_id:e}),Coconut.questionView.result.fetch({success:function(){return Coconut.questionView.model=new Question({id:Coconut.questionView.result.question()}),Coconut.questionView.model.fetch({success:function(){return Coconut.questionView.render()}})}})}})},n.prototype.deleteResult=function(e,n){return this.userLoggedIn({success:function(){return null==Coconut.questionView&&(Coconut.questionView=new QuestionView),Coconut.questionView.readonly=!0,Coconut.questionView.result=new Result({_id:e}),Coconut.questionView.result.fetch({success:function(){return"confirmed"===n?Coconut.questionView.result.destroy({success:function(){return Coconut.menuView.update(),Coconut.router.navigate("show/results/"+escape(Coconut.questionView.result.question()),!0)}}):(Coconut.questionView.model=new Question({id:Coconut.questionView.result.question()}),Coconut.questionView.model.fetch({success:function(){return Coconut.questionView.render(),$("#content").prepend("<h2>Are you sure you want to delete this result?</h2> <div id='confirm'> <a href='#delete/result/"+e+"/confirmed'>Yes</a> <a href='#show/results/"+escape(Coconut.questionView.result.question())+"'>Cancel</a> </div>"),$("#confirm a").button(),$("#content form").css({"background-color":"#333",margin:"50px",padding:"10px"}),$("#content form label").css({color:"white"})}}))}})}})},n.prototype.design=function(){return this.userLoggedIn({success:function(){return $("#content").empty(),null==Coconut.designView&&(Coconut.designView=new DesignView),Coconut.designView.render()}})},n.prototype.showResults=function(e){return this.userLoggedIn({success:function(){return null==Coconut.resultsView&&(Coconut.resultsView=new ResultsView),Coconut.resultsView.question=new Question({id:unescape(e)}),Coconut.resultsView.question.fetch({success:function(){return Coconut.resultsView.render()}})}})},n.prototype.map=function(){return this.userLoggedIn({success:function(){return null==Coconut.mapView&&(Coconut.mapView=new MapView),Coconut.mapView.render()}})},n.prototype.startApp=function(){return Coconut.config=new Config,Coconut.config.fetch({success:function(){return $("#footer-menu").html("<center> <span style='font-size:75%;display:inline-block'> <span id='district'></span><br/> <span id='user'></span> </span> <a href='#login'>Login</a> <a href='#logout'>Logout</a> <a id='reports' href='#reports'>Reports</a> <a id='manage-button' style='display:none' href='#manage'>Manage</a> &nbsp; <a href='#sync/send'>Send data (last done: <span class='sync-sent-status'></span>)</a> <a href='#sync/get'>Update (last done: <span class='sync-get-status'></span>)</a> <a href='#help'>Help</a> <span style='font-size:75%;display:inline-block'>Version<br/><span id='version'></span></span> </center>"),$("[data-role=footer]").navbar(),$("#application-title").html(Coconut.config.title()),Coconut.loginView=new LoginView,Coconut.questions=new QuestionCollection,Coconut.questionView=new QuestionView,Coconut.menuView=new MenuView,Coconut.syncView=new SyncView,Coconut.menuView.render(),Coconut.syncView.update(),Backbone.history.start()},error:function(){return null==Coconut.localConfigView&&(Coconut.localConfigView=new LocalConfigView),Coconut.localConfigView.render()}})},n}(Backbone.Router),Coconut={},Coconut.router=new Router,Coconut.router.startApp(),Coconut.debug=function(e){return console.log(e),$("#log").append(e+"<br/>")};